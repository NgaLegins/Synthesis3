<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Substance - Hydra Visualization</title>
    <style>
        body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* Overlay per avviare audio/video (necessario per i browser moderni) */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: 'Arial', sans-serif;
            font-size: 2rem;
            z-index: 10;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
    <script src="https://unpkg.com/hydra-synth"></script>
</head>
<body>

    <div id="start-overlay">
        > Clicca per attivare la Sostanza <
    </div>

    <script>
        // 1. SETUP INIZIALE
        const overlay = document.getElementById('start-overlay');
        
        // Inizializza Hydra nel body
        const hydra = new Hydra({
            detectAudio: false,
            enableStreamCapture: false,
        });

        // Variabili Globali
        let ctxAudio;
        let imgText = new Image(); // L'immagine che conterrà l'SVG
        let words = "HAVE YOU EVER DREAMED OF A BETTER VERSION OF YOURSELF ?".split(" ");
        let lastIndex = -1;
        let speed = 1.1;
        let triggerDreamFlash = 0;
        let startTime = Date.now();

        // 2. FUNZIONE AUDIO (THE SUBSTANCE NOISE)
        function initAudio() {
            ctxAudio = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSubstanceNoise() {
            if (!ctxAudio) return;
            if (ctxAudio.state === 'suspended') ctxAudio.resume();
            
            const osc = ctxAudio.createOscillator();
            const gain = ctxAudio.createGain();
            
            // Suono Sawtooth (dente di sega) profondo
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(55, ctxAudio.currentTime);
            osc.frequency.exponentialRampToValueAtTime(15, ctxAudio.currentTime + 0.25);
            
            gain.gain.setValueAtTime(0.4, ctxAudio.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctxAudio.currentTime + 0.25);
            
            osc.connect(gain);
            gain.connect(ctxAudio.destination);
            osc.start();
            osc.stop(ctxAudio.currentTime + 0.25);
        }

        // 3. GENERATORE SVG
        function updateSVGText(word) {
            // Definiamo l'SVG come stringa.
            // NOTA: I font esterni dentro un <img> SVG spesso vengono bloccati dai browser per sicurezza.
            // Usiamo un font-stack robusto (Impact, Arial Black) che simula lo stile se il fetch fallisce.
            const svgString = `
            <svg xmlns="http://www.w3.org/2000/svg" width="1920" height="1080">
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');
                    .text { 
                        font-family: 'Bebas Neue', Impact, 'Arial Black', sans-serif; 
                        fill: white; 
                        font-size: 250px; 
                        text-anchor: middle; 
                        dominant-baseline: middle; 
                    }
                </style>
                <rect width="100%" height="100%" fill="transparent" />
                <text x="50%" y="50%" class="text">${word}</text>
            </svg>`;

            // Convertiamo la stringa SVG in un Blob URL
            const blob = new Blob([svgString], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            
            // Aggiorniamo l'immagine sorgente
            const newImg = new Image();
            newImg.onload = () => {
                imgText = newImg; // Scambiamo l'immagine solo quando è pronta
                URL.revokeObjectURL(url); // Pulizia memoria
            };
            newImg.src = url;
        }

        // 4. LOGICA DI AGGIORNAMENTO (LOOP)
        // Usiamo una funzione custom che viene chiamata ogni frame da Hydra o esternamente
        function logicUpdate(time) {
            let index = Math.floor(time * speed) % words.length;
            
            if (index !== lastIndex) {
                let currentWord = words[index];
                
                // Aggiorna SVG
                updateSVGText(currentWord);
                
                // Logica Trigger Flash
                if (currentWord === "DREAMED") {
                    triggerDreamFlash = 1;
                } else {
                    triggerDreamFlash = 0;
                }
                
                // Suona
                playSubstanceNoise();
                
                lastIndex = index;
            }
        }

        // 5. CLICK HANDLER (AVVIO)
        overlay.addEventListener('click', () => {
            overlay.style.display = 'none';
            initAudio();
            s0.initCam(); // Avvia la webcam
            
            // Inizializza s1 con l'immagine dinamica
            s1.init({ src: () => imgText, dynamic: true });

            // --- CODICE VISUALE HYDRA ---
            
            // Definiamo la "Mutazione" (sfondo)
            viscere = src(s0)
                .saturate(3)
                .modulate(noise(4, 0.2)) 
                .color(0.5, 1, 0.5) 
                .kaleid(1) 

            // Definiamo il "Soggetto" (Tu)
            soggetto = src(s0)
                .contrast(2) 
                .brightness(-0.2)
                .modulate(noise(1, 0.1), 0.1)
                .blend(o0, 0.4)

            // Effetto Testo
            testoEffect = src(s1)
                // Applica invert solo se triggerDreamFlash è 1
                .invert(() => triggerDreamFlash * (Math.sin(time * 50) > 0 ? 1 : 0))
                .scale(1.05)

            // Composizione
            viscere
                .layer(soggetto.luma(0.4, 0.1)) 
                .layer(testoEffect.luma(0.5, 0.01)) 
                .out()
            
            // Aggancia la nostra logica custom al loop di rendering di Hydra
            // Hydra ha una variabile globale 'time' che scorre
            const oldUpdate = update; // Salviamo eventuale update esistente
            update = (dt) => {
                if(oldUpdate) oldUpdate(dt);
                logicUpdate(time); // Chiamiamo la nostra logica usando il tempo di Hydra
            }
        });

    </script>
</body>
</html>
