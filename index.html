<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Substance - Hydra Final</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; background-color: black; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* Canvas nascosto che useremo per generare il testo */
        #text-canvas {
            display: none; /* Non lo mostriamo direttamente, lo passiamo a Hydra */
        }

        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            z-index: 10;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: opacity 0.5s;
        }
        #start-overlay p { margin: 0; font-size: 1.2rem; font-family: sans-serif; opacity: 0.7; margin-top: 10px;}
    </style>
    <script src="https://unpkg.com/hydra-synth"></script>
</head>
<body>

    <div id="start-overlay">
        CLICCA PER INIZIARE
        <p>Attiva webcam e audio</p>
    </div>

    <canvas id="text-canvas" width="1920" height="1080"></canvas>

    <script>
        const overlay = document.getElementById('start-overlay');
        const textCanvas = document.getElementById('text-canvas');
        const textCtx = textCanvas.getContext('2d');

        // Inizializza Hydra
        const hydra = new Hydra({
            detectAudio: false,
            enableStreamCapture: false,
        });

        // VARIABILI GLOBALI
        let ctxAudio;
        let words = "HAVE YOU EVER DREAMED OF A BETTER VERSION OF YOURSELF ?".split(" ");
        let lastIndex = -1;
        let speed = 1.1;
        let triggerDreamFlash = 0;

        // 1. GESTIONE AUDIO
        function initAudio() {
            ctxAudio = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSubstanceNoise() {
            if (!ctxAudio) return;
            if (ctxAudio.state === 'suspended') ctxAudio.resume();
            
            const osc = ctxAudio.createOscillator();
            const gain = ctxAudio.createGain();
            
            // Suono Sawtooth aggressivo
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(55, ctxAudio.currentTime);
            osc.frequency.exponentialRampToValueAtTime(10, ctxAudio.currentTime + 0.3);
            
            gain.gain.setValueAtTime(0.35, ctxAudio.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctxAudio.currentTime + 0.3);
            
            osc.connect(gain);
            gain.connect(ctxAudio.destination);
            osc.start();
            osc.stop(ctxAudio.currentTime + 0.35);
        }

        // 2. FUNZIONE DISEGNO TESTO
        function drawText(word) {
            // Pulisce il canvas
            textCtx.clearRect(0, 0, textCanvas.width, textCanvas.height);
            
            // Impostazioni Font
            textCtx.font = "250px 'Bebas Neue'";
            textCtx.fillStyle = "white";
            textCtx.textAlign = "center";
            textCtx.textBaseline = "middle";
            
            // Disegna
            textCtx.fillText(word, textCanvas.width / 2, textCanvas.height / 2);
        }

        // 3. LOGICA DI LOOP (Chiamata da Hydra)
        function logicUpdate(time) {
            // Calcolo indice parola
            let index = Math.floor(time * speed) % words.length;
            
            // Se Ã¨ cambiata la parola rispetto al frame precedente
            if (index !== lastIndex) {
                let currentWord = words[index];
                
                // 1. Disegna la nuova parola sul canvas nascosto
                drawText(currentWord);
                
                // 2. Logica Trigger Flash per "DREAMED"
                if (currentWord === "DREAMED") {
                    triggerDreamFlash = 1;
                } else {
                    triggerDreamFlash = 0;
                }
                
                // 3. Suono
                playSubstanceNoise();
                
                lastIndex = index;
            }
        }

        // 4. AVVIO AL CLICK
        overlay.addEventListener('click', async () => {
            // Nascondi overlay
            overlay.style.opacity = 0;
            setTimeout(() => overlay.style.display = 'none', 500);

            // Avvia Audio e Video
            initAudio();
            s0.initCam(); 
            
            // Inizializza la texture s1 collegandola al canvas del testo
            s1.init({ src: textCanvas });

            // --- CODICE VISIVO HYDRA ---
            
            // Sfondo (Viscere)
            viscere = src(s0)
                .saturate(3)
                .modulate(noise(4, 0.2)) 
                .color(0.5, 1, 0.5) 
                .kaleid(1) 

            // Soggetto (Tu)
            soggetto = src(s0)
                .contrast(2) 
                .brightness(-0.2)
                .modulate(noise(1, 0.1), 0.1)
                .blend(o0, 0.4)

            // Effetto Testo (prende s1 che contiene il canvas)
            testoEffect = src(s1)
                // Inverte colori velocemente SOLO se triggerDreamFlash == 1
                .invert(() => triggerDreamFlash * (Math.sin(time * 60) > 0 ? 1 : 0))
                .scale(1.05) // Leggero ingrandimento fisso per impatto

            // Composizione Finale
            viscere
                .layer(soggetto.luma(0.4, 0.1)) // Ritaglia soggetto su viscere
                .layer(testoEffect.luma(0.5, 0.01)) // Ritaglia testo bianco sopra tutto
                .out()
            
            // --- LOOP ---
            // Sovrascriviamo la funzione update di Hydra per inserire la nostra logica
            const oldUpdate = update;
            update = (dt) => {
                logicUpdate(time); // Aggiorna testo e audio
                if(oldUpdate) oldUpdate(dt);
            }
        });

    </script>
</body>
</html>
